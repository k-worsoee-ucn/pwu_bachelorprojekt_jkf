generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// PREDEFINED VALUES (ENUMERATIONS)

enum ProcessStatus {
  done
  ongoing
  locked
}

enum UserRole {
  salesManager
  marketingManager
  viewer
}

// MODELS

model Process {
  id     Int           @id @default(autoincrement())
  title  String
  caseNo Int           @unique
  status ProcessStatus @default(ongoing)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Many-to-many with users through join table
  processUsers ProcessUser[]

  // One-to-one relationship
  sale Sale?

  // One-to-many relationships
  references Reference[]
  products   Product[]
  cases      Case[]

  @@map("processes")
}

model Sale {
  id               Int    @id @default(autoincrement())
  industry         String
  country          String
  filterType       String
  fanType          String
  ductSystem       String
  extractionVolume Int
  volumeFlow       Int

  // FK
  processId      Int @unique @map("process_id")
  customerId     Int @map("customer_id")
  salesManagerId Int @map("sales_manager_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  process      Process  @relation(fields: [processId], references: [id], onDelete: Cascade)
  customer     Customer @relation(fields: [customerId], references: [id])
  salesManager User     @relation("OwnedSales", fields: [salesManagerId], references: [id])

  saleProducts SaleProduct[]

  @@map("sales")
}

model User {
  id       Int      @id @default(autoincrement())
  email    String   @unique
  password String
  name     String
  role     UserRole @default(viewer)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  processUsers ProcessUser[]

  ownedSales Sale[] @relation("OwnedSales")

  managedCustomers Customer[] @relation("CustomerSalesManager")

  @@map("users")
}

model ProcessUser {
  processId  Int
  userId     Int
  role       UserRole
  assignedAt DateTime @default(now())
  assignedBy Int?
  isActive   Boolean  @default(true)

  process Process @relation(fields: [processId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([processId, userId, role])
  @@map("process_users")
}

model Customer {
  id       Int    @id @default(autoincrement())
  name     String @unique

  // Each customer has exactly ONE sales manager
  salesManagerId Int @map("sales_manager_id")

  createdAt DateTime @default(now())

  // Relationships
  salesManager User   @relation("CustomerSalesManager", fields: [salesManagerId], references: [id])
  sales        Sale[]

  @@map("customers")
}

model Product {
  id          Int    @id @default(autoincrement())
  title       String
  processId   Int?   @map("process_id")
  referenceId Int?   @map("reference_id")
  caseId      Int?   @map("case_id")

  // Relationships
  process      Process?   @relation(fields: [processId], references: [id])
  reference    Reference? @relation(fields: [referenceId], references: [id])
  case         Case?      @relation(fields: [caseId], references: [id])
  saleProducts SaleProduct[]

  @@map("products")
}

model SaleProduct {
  saleId    Int
  productId Int
  quantity  Int @default(1)

  createdAt DateTime @default(now())

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([saleId, productId])
  @@map("sale_products")
}

model Reference {
  id        Int @id @default(autoincrement())
  processId Int? @map("process_id")

  createdAt DateTime @default(now())

  // Relationships
  process  Process? @relation(fields: [processId], references: [id])
  products Product[]
  cases    Case[]

  @@map("references")
}

model Case {
  id          Int    @id @default(autoincrement())
  content     String
  processId   Int?   @map("process_id")
  referenceId Int?   @map("reference_id")

  createdAt DateTime @default(now())

  // Relationships
  process   Process?   @relation(fields: [processId], references: [id])
  reference Reference? @relation(fields: [referenceId], references: [id])
  products  Product[]

  @@map("cases")
}
