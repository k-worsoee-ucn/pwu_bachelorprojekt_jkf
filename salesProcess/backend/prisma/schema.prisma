generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// PREDEFINED VALUES (ENUMERATIONS)

enum ProcessStatus {
  completed @map("Completed")
  ongoing   @map("Ongoing")
  locked    @map("Locked")
}

enum UserRole {
  salesManager     @map("Sales Manager")
  marketingManager @map("Marketing Manager")
  viewer           @map("Viewer")
}

enum Industry {
  woodworking    @map("Woodworking")
  agroAndMilling @map("Agro- and Milling")
  recycling      @map("Recycling")
  metalworking   @map("Metalworking")
  paper          @map("Paper")
  other          @map("Other")
}

enum ProductCategory {
  filtersAndSeparators @map("Filters & Separators")
  fanSystems           @map("Fan Systems")
  ductSystems          @map("Duct Systems")
}

// MODELS

model Process {
  id           Int           @id @default(autoincrement())
  title        String
  caseNo       Int           @unique
  status       ProcessStatus @default(ongoing)
  currentStep  Int           @default(1)
  consent      Boolean       @default(false)
  shippingDate String?       @map("shipping_date")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Many-to-many with users through join table
  processUsers ProcessUser[]

  // One-to-one relationship
  sale Sale?

  // One-to-many relationships
  references Reference[]
  cases      Case[]
  images     Image[]

  @@map("processes")
}

model Sale {
  id                    Int      @id @default(autoincrement())
  title                 String
  description           String?
  endUser               String   @map("end_user")
  country               String
  industry              Industry
  customIndustry        String?  @map("custom_industry")
  plantType             String   @map("plant_type")
  filterType            String   @map("filter_type")
  fanType               String   @map("fan_type")
  dustType              String   @map("dust_type")
  ductSystem            String   @map("duct_system")
  totalExtractionVolume Int      @map("total_extraction_volume")
  pressure              Int
  volumeFlow            Int      @map("volume_flow")
  phoneNumber           String?  @map("phone_number")
  privacySettings       Json?    @map("privacy_settings")

  // FK
  processId      Int @unique @map("process_id")
  customerId     Int @map("customer_id")
  salesManagerId Int @map("sales_manager_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  process      Process  @relation(fields: [processId], references: [id], onDelete: Cascade)
  customer     Customer @relation(fields: [customerId], references: [id])
  salesManager User     @relation("OwnedSales", fields: [salesManagerId], references: [id])

  saleProducts SaleProduct[]

  @@map("sales")
}

model User {
  id       Int      @id @default(autoincrement())
  email    String   @unique
  password String
  name     String
  role     UserRole @default(viewer)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  processUsers ProcessUser[]

  ownedSales Sale[] @relation("OwnedSales")

  managedCustomers Customer[] @relation("CustomerSalesManager")

  @@map("users")
}

model ProcessUser {
  processId  Int
  userId     Int
  role       UserRole
  assignedAt DateTime @default(now())
  assignedBy Int?
  isActive   Boolean  @default(true)

  process Process @relation(fields: [processId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([processId, userId, role])
  @@map("process_users")
}

model Customer {
  id      Int     @id @default(autoincrement())
  name    String  @unique
  website String?

  // Each customer has exactly ONE sales manager
  salesManagerId Int @map("sales_manager_id")

  createdAt DateTime @default(now())

  // Relationships
  salesManager User   @relation("CustomerSalesManager", fields: [salesManagerId], references: [id])
  sales        Sale[]

  @@map("customers")
}

model Product {
  id    Int             @id @default(autoincrement())
  title String
  category    ProductCategory

  // Relationships
  saleProducts SaleProduct[]

  @@map("products")
}

model SaleProduct {
  saleId    Int
  productId Int
  quantity  Int @default(1)

  createdAt DateTime @default(now())

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([saleId, productId])
  @@map("sale_products")
}

model Reference {
  id        Int  @id @default(autoincrement())
  processId Int? @map("process_id")

  createdAt DateTime @default(now())

  // Relationships
  process  Process?  @relation(fields: [processId], references: [id])
  cases    Case[]

  @@map("references")
}

model Case {
  id          Int    @id @default(autoincrement())
  content     String
  processId   Int?   @map("process_id")
  referenceId Int?   @map("reference_id")

  createdAt DateTime @default(now())

  // Relationships
  process   Process?   @relation(fields: [processId], references: [id])
  reference Reference? @relation(fields: [referenceId], references: [id])

  @@map("cases")
}

model Image {
  id        Int      @id @default(autoincrement())
  url       String
  filename  String
  type      String   @default("production") // "production" or "installation"
  createdAt DateTime @default(now())
  process   Process  @relation(fields: [processId], references: [id])
  processId Int

  @@map("images")
}